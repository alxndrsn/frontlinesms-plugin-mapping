/**
 * 
 */
package org.smslib;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.StringReader;
import java.lang.reflect.Field;

import org.apache.log4j.Logger;

import net.frontlinesms.junit.BaseTestCase;

/**
 * @author Alex
 *
 */
public class CServiceTest extends BaseTestCase {
	private static final Logger LOG = Logger.getLogger(CServiceTest.class);
	
	private static final int BAUD = 9200;
	private static final String PORT = "COM0";
	private CService service;
	private MockSerialDriver serialDriver; 
	
	@Override
	protected void setUp() throws Exception {
		this.service = new CService(PORT, BAUD, "Masabi", "Test Service", "Mock");
		this.serialDriver = new MockSerialDriver(PORT, BAUD, this.service);
		service.serialDriver = this.serialDriver;
		
		// "Connect" the service
		Field connectedField = this.service.getClass().getDeclaredField("connected");
		connectedField.setAccessible(true);
		connectedField.set(this.service, Boolean.TRUE);
	}
	
	private static final Object[][] TEST_PDUS = new Object[][] {
		new Object[]{"", new String[]{"0031000AA160480173770000FF06E3777DFCAE03"}},
		new Object[]{"07890123456", new String[]{"07A17098103254F631000AA160480173770000FF06E3777DFCAE03"}},
		new Object[]{"0789012345", new String[]{"06A1709810325431000AA160480173770000FF06E3777DFCAE03"}},
		new Object[]{"+447890123456", new String[]{"079144870921436531000AA160480173770000FF06E3777DFCAE03"}},
		new Object[]{"+44789012345", new String[]{"07914487092143F531000AA160480173770000FF06E3777DFCAE03"}},
	};
	
	public void testSendMessage_PDU() throws Throwable {
		for(Object[] o : TEST_PDUS) {
			String smscNumber = (String)o[0];
			COutgoingMessage outgoingMessage = new MockOutgoingMessage(smscNumber, (String[])o[1]);
			service.setSmscNumber(smscNumber);
			service.sendMessage_PDU(outgoingMessage);
		}
	}
	
	@Override
	protected void tearDown() throws Exception {
		this.service = null;
		this.serialDriver = null;
	}
	
	/** Responses to the listMessages AT command that should be succesfully parsed. */
	private static final String[] MESSAGE_LIST_RESPONSES = {
		"+CMGL: 1,1,,142\n0791449737019037040BD04F79D87D2E030000902091610474008CC834C82C7FB7414F79D87D2EBB40D437E85CA683F2EFBA1C447CB3E1E8B41B242FDFC372F21CE42EE3E9A0F6DB4D47B340EAFA9C0EA2BFE1AD3A1C24CE83023118E82D07B5DFF232485C36BFE565908CF682C95EB09C0B947483E8E832881D9ED3413318881CCECF41F977FD642F83E86F38BC4C06D5E1A000CC05\n+CMGL: 2,0,,26\n0791447728008000040C9144978851560500009030215153950008D972180DBA97D3\nOK",
		"\n+CMGL: 1,1,,152\n0791449737709499440C9144877327605700008060904185124098060804B0930301B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562\n\n+CMGL: 2,1,,152\n0791449737709499440C9144877327605700008060905100934098060804A4680301B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562\n\n+CMGL: 3,1,,152\n0791449737709499440C91448773276057000080609051401240980608046DE80301B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562\n\n+CMGL: 4,1,,152\n0791449737709499440C9144877327605700008060905160844098060804A16A0301B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562\n\n+CMGL: 5,1,,152\n0791449737709499440C914487732760570000806090514153409806080412290301B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562\n\n+CMGL: 6,1,,152\n0791449737709499440C9144877327605700008060905112354098060804D7DB0301B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562B1582C168BC562\n\n+CMGL: 7,1,,159\n0791447728008000440C91449788515605000090203171028200A0050003150202EFE5B49C0C32CBDF6D10BA2C2F835AA0F41C94A683E67532B9EC66E74175B7BC1C2687C5EC320B24CE83C2EE3C688C0EBBC7E55F08842CCBCBA739888E2E83C26472990C12BFDDF539E86D06D1D16510FDFE06B5CBF379F85C0689DF7537392CCFBB5C2ED0F4DD2EDFD16579D9E57281AEE8B2BC0C4ACF4169FA0F94048DC3EE131D342F97DB\n\n+CMGL: 8,1,,159\n0791448720003023400C914467420873770004806011111380408C0B0504000000000003B90302808182838485868788898A8B8C8D8E8F909192939495969798999A9B9C9D9E9FA0A1A2A3A4A5A6A7A8A9AAABACADAEAFB0B1B2B3B4B5B6B7B8B9BABBBCBDBEBFC0C1C2C3C4C5C6C7C8C9CACBCCCDCECFD0D1D2D3D4D5D6D7D8D9DADBDCDDDEDFE0E1E2E3E4E5E6E7E8E9EAEBECEDEEEFF0F1F2F3F4F5F6F7F8F9FAFBFCFDFEFF\n\n+CMGL: 9,1,,75\n0791448720003023440C91446742087377000480601111138040380B0504000000000003B90303000102030405060708090A0B0C0D0E0F101112131415161718191A1B1C1D1E1F202122232425262728292A2B\n\n+CMGL: 10,1,,159\n0791449737709499440C91448773276057000080708031005340A005000347020189EFBA985D06B5CBF379F85C7681826E7A985D06B5CBF379F81C0691DF7531BB4C06B5CBF379F81C0685DDF430BB0C0ABBE9617619447FA7D9A0B09B0C9ABBEBE375590E7AB3C9A0F0B9CE9E83DA6C1B1DCD0699DF6CFA1BD466B7E96E503B4FBFD7F5F57B5D5FBFD7F5F57B5D5FBFD7F5F57B5D5FBFD7F5F57B5D5FBFD7F5F57B5D5FBFD7F5\n\n+CMGL: 11,1,,47\n0791449737709499440C914487732760570000807051117230401F06080400230202ED73FBDC3EB7CFED33FC0EBFC3EFF07BFC0EBFC301\n\n+CMGL: 12,1,,25\n079144973770939906660C91449788515605903021514363009030215143040000\n\n+CMGL: 13,1,,25\n079144973770939906670C91449788515605903021514335009030215153100000\n\n+CMGL: 14,1,,25\n079144973770939906680C91449788515605903021515381009030215153620000\n+CMGL: 15,1,,146\n0791449737709499440C914487732760570004806011711065407F0C0504000000000804222A0301150001020A012C000102030405060708090A0B0C0D0E0F101112131415161718191A1B1C1D1E1F202122232425262728292A2B2C2D2E2F303132333435363738393A3B3C3D3E3F404142434445464748494A4B4C4D4E4F505152535455565758595A5B5C5D5E5F606162636465666768696A\n\n+CMGL: 16,1,,25\n079144973770939906690C91449788515605903021515393009030215153440000\n\n+CMGL: 17,0,,29\n0791447728008000040C914497885156050000903021516301000B53F6FB0E82A3DFEE7208\n\n\nOK",
	};
	
//	Can't get this working yet, but it should be something like this
//	public void testReadMessages_PDU() throws NotConnectedException, UnrecognizedHandlerProtocolException, IOException {
//		for(String atResponse : MESSAGE_LIST_RESPONSES) {
//			testReadMessages_PDU(atResponse);
//		}
//	}
//	
//	private void testReadMessages_PDU(String atResponse) throws NotConnectedException, UnrecognizedHandlerProtocolException, IOException {
//		LinkedList<CIncomingMessage> messageList = new LinkedList<CIncomingMessage>();
//		this.service.readMessages(messageList, CService.MessageClass.All);
//	}
	
	public void testGetNextUsefulLine() throws IOException {
		for(String response : MESSAGE_LIST_RESPONSES) {
			String[] responseParts = response.split("\n");
			BufferedReader reader = new BufferedReader(new StringReader(response));
			for(String responsePart : responseParts) {
				if(responsePart.length() == 0) {
					LOG.trace("Ignoring empty line.");
				} else {
					assertEquals("Incorrect line fetched.", responsePart, CService.getNextUsefulLine(reader));
				}
			}
		}
	}
	
	/** Pairs mapping expected memory indexes to the lines that they should be extracted from. */
	private static final Object[][] MEMORY_INDEXES = {
		new Object[]{1, "+CMGL: 1,1,,142"},
		new Object[]{2, "+CMGL: 2,0,,26"},
		new Object[]{1, "+CMGL: 1,1,,152"},
		new Object[]{10, "+CMGL: 10,1,,159"},
	};
	
	public void testGetMemoryIndex() {
		for(Object[] m : MEMORY_INDEXES) {
			String line = (String)m[1];
			int expectedIndex = (Integer)m[0];
			assertEquals("Incorrect memory index read from line: " + line, expectedIndex, CService.getMemIndex(line));
		}
	}
}
